<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Building Details | DISPRO</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #dfe6ea; color: #333; }
        .top-bar { padding: 20px 40px; }
        .back { font-size: 22px; text-decoration: none; color: #000; transition: 0.3s; }
        .back:hover { color: #2563eb; }
        .title { text-align: center; margin-bottom: 20px; }
        .title h1 { font-size: 32px; font-weight: 700; }
        
        /* Updated RVS Box Styles */
        .rvs-box { text-align: center; margin-bottom: 20px; padding: 15px; border-radius: 15px; }
        .score-val { font-size: 2.5rem; font-weight: 700; display: block; }
        .risk-label { font-size: 1.2rem; font-weight: 600; margin-top: 5px; }
        .risk-low { color: #10b981; }      /* Green */
        .risk-moderate { color: #f59e0b; } /* Orange */
        .risk-high { color: #ef4444; }     /* Red */
        .risk-critical { color: #7f1d1d; text-transform: uppercase; }

        .form-container { width: 70%; margin: auto; background: rgba(255,255,255,0.9); border-radius: 25px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 22px; }
        label { font-weight: 600; display: block; margin-bottom: 8px; }
        input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-family: inherit; }
        input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 5px rgba(37, 99, 235, 0.2); }
        .options { display: flex; flex-wrap: wrap; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 10px; }
        
        .info { margin-left: 6px; cursor: help; color: #2563eb; font-weight: 700; }
        .submit-btn { display: block; margin: 30px auto 0; padding: 15px 45px; background: #2563eb; color: #fff; border: none; border-radius: 30px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .submit-btn:hover { background: #1d4ed8; transform: translateY(-2px); }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="web3.html" class="back">‚Üê Back to Home</a>
</div>

<div class="title">
    <h1>Building Vulnerability Assessment</h1>
</div>

<div class="rvs-box" id="rvsDisplayBox">
    <span class="score-val" id="rvsScoreDisplay">S: --</span>
    <div class="risk-label" id="riskLevel">Calculate to see risk level</div>
    <small id="zoneText">Zone: --</small>
</div>

<div class="form-container">
    <form id="rvsForm">
        <div class="form-group">
            <label>Building Address *</label>
            <input type="text" id="address" placeholder="House no., Street, City, State" required>
        </div>

        <div class="form-group">
            <label>Coordinates *</label>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="lat" placeholder="Latitude (e.g. 31.1)" step="any" required>
                <input type="number" id="lon" placeholder="Longitude (e.g. 77.1)" step="any" required>
            </div>
        </div>

        <div class="form-group">
            <label>No. of Stories</label>
            <input type="number" id="stories" min="1" value="1">
        </div>

        <div class="form-group">
            <label>Year Built</label>
            <input type="number" id="year" placeholder="YYYY">
        </div>

        <div class="form-group">
            <label>Building Use</label>
            <div class="options">
                <label><input type="radio" name="use" value="residential" checked> Residential</label>
                <label><input type="radio" name="use" value="commercial"> Commercial</label>
                <label><input type="radio" name="use" value="industrial"> Industrial</label>
                <label><input type="radio" name="use" value="public"> Public/Essential</label>
            </div>
        </div>

        <div class="form-group">
            <label>Soil Type</label>
            <div class="options">
                <label><input type="radio" name="soil" value="hard" checked> Hard (Rock)</label>
                <label><input type="radio" name="soil" value="medium"> Medium</label>
                <label><input type="radio" name="soil" value="soft"> Soft (Alluvium)</label>
            </div>
        </div>

        <div class="form-group">
            <label>Structural System *</label>
            <div class="options">
                <label><input type="radio" name="type" value="RC" checked> RC Frame</label>
                <label><input type="radio" name="type" value="URM"> Masonry (URM)</label>
                <label><input type="radio" name="type" value="STEEL"> Steel Frame</label>
                <label><input type="radio" name="type" value="WOOD"> Wood</label>
                <label><input type="radio" name="type" value="MIXED"> Mixed</label>
            </div>
        </div>

        <button type="button" class="submit-btn" onclick="processAssessment()">Submit & Analyze</button>
    </form>
</div>

<script>
/**
 * Maps lat/lon to India's Revised Seismic Map 2025
 * Includes new Zone VI for the Himalayan Belt
 */
function getSeismicZone(lat, lon) {
    // Himalayan corridor (J&K, Ladakh, HP, Uttarakhand, Sikkim, Arunachal)
    if (lat > 32 || (lat > 27 && lon > 88) || (lat > 30 && lon < 80)) return "VI";
    if (lat > 26) return "V";
    if (lat > 23) return "IV";
    if (lat > 20) return "III";
    return "II";
}

function processAssessment() {
    const address = document.getElementById("address").value;
    const lat = parseFloat(document.getElementById("lat").value);
    const lon = parseFloat(document.getElementById("lon").value);
    const stories = parseInt(document.getElementById("stories").value);
    const year = parseInt(document.getElementById("year").value);

    // Form Validation
    if (!address || isNaN(lat) || isNaN(lon)) {
        alert("Please provide address and valid coordinates.");
        return;
    }

    const soil = document.querySelector('input[name="soil"]:checked').value;
    const type = document.querySelector('input[name="type"]:checked').value;
    const use = document.querySelector('input[name="use"]:checked').value;

    const zone = getSeismicZone(lat, lon);
    document.getElementById("zoneText").innerText = `Seismic Zone: ${zone} (Map 2025)`;

    // Base Scores for India's Seismicity Levels
    // Zone VI requires ~50-60% higher earthquake resistance
    const base = {
        II: { RC: 4.0, URM: 3.0, STEEL: 4.5, WOOD: 4.8, MIXED: 3.5 },
        III: { RC: 3.6, URM: 2.5, STEEL: 4.0, WOOD: 4.2, MIXED: 3.0 },
        IV: { RC: 3.0, URM: 1.8, STEEL: 3.5, WOOD: 3.8, MIXED: 2.4 },
        V: { RC: 2.4, URM: 1.2, STEEL: 3.0, WOOD: 3.2, MIXED: 1.8 },
        VI: { RC: 1.8, URM: 0.8, STEEL: 2.2, WOOD: 2.5, MIXED: 1.2 } 
    };

    let score = base[zone][type];

    // Score Modifiers
    if (stories > 3) score -= 0.5;
    if (stories > 7) score -= 0.5;
    if (year < 2005) score -= 0.4; // Pre-modern seismic code
    if (soil === "soft") score -= 0.8;
    if (soil === "medium") score -= 0.3;
    if (use === "public") score += 0.5; // Essential facilities have higher safety requirements

    score = Math.max(0.1, parseFloat(score.toFixed(1)));
    updateUI(score);

    // Fetch data save
    fetch("http://localhost:5000/api/building/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address, latitude: lat, longitude: lon, rvsScore: score, zone })
    })
    .then(() => setTimeout(() => window.location.href = "weather.html", 2000))
    .catch(err => console.error("Error saving assessment:", err));
}

function updateUI(score) {
    const scoreDisp = document.getElementById("rvsScoreDisplay");
    const labelDisp = document.getElementById("riskLevel");
    
    scoreDisp.innerText = `S = ${score}`;
    
    // Categorize Risk Level
    if (score >= 3.0) {
        labelDisp.innerText = "LOW RISK: Safe for occupancy";
        labelDisp.className = "risk-label risk-low";
    } else if (score >= 2.0) {
        labelDisp.innerText = "MODERATE RISK: Retrofitting recommended";
        labelDisp.className = "risk-label risk-moderate";
    } else {
        labelDisp.innerText = "HIGH RISK: Immediate detailed evaluation needed";
        labelDisp.className = "risk-label risk-high";
    }
}
</script>

</body>
</html>